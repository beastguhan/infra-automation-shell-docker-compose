version: "3.9"
services:
jenkins:
image: jenkins/jenkins:lts
container_name: infra_jenkins
user: "0:0"
restart: unless-stopped
ports:
- "8080:8080"
- "50000:50000"
volumes:
- jenkins_home:/var/jenkins_home
- ./jenkins/plugins.txt:/usr/share/jenkins/ref/plugins.txt:ro
healthcheck:
test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
interval: 10s
timeout: 5s
retries: 12


redis:
image: redis:7-alpine
container_name: infra_redis
restart: unless-stopped
ports:
- "6379:6379"
healthcheck:
test: ["CMD", "redis-cli", "ping"]
interval: 10s
timeout: 5s
retries: 5


sample-app:
build: ./app
container_name: infra_app
restart: unless-stopped
ports:
- "5000:5000"
environment:
- REDIS_HOST=redis
- REDIS_PORT=6379
depends_on:
- redis
healthcheck:
test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
interval: 5s
timeout: 3s
retries: 5


nginx:
image: nginx:stable-alpine
container_name: infra_nginx
restart: unless-stopped
ports:
- "80:80"
volumes:
- ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
depends_on:
- sample-app
healthcheck:
test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
interval: 10s
timeout: 5s
retries: 5


volumes:
jenkins_home:
